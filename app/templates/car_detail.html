{% extends "base.html" %}

{% block title %}{{ car.brand }} {{ car.model }} - CarMarket{% endblock %}

{% block content %}
<div class="container py-5">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('routes.index') }}" class="text-success text-decoration-none">Начало</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('routes.search') }}" class="text-success text-decoration-none">Обяви</a></li>
            <li class="breadcrumb-item active text-white opacity-50" aria-current="page">{{ car.brand }} {{ car.model }}</li>
        </ol>
    </nav>

    <div class="row g-5">
        <div class="col-lg-8">
            <div class="main-image-container rounded-4 overflow-hidden mb-3 shadow-lg border border-secondary border-opacity-25 bg-dark">
                {% if car.images %}
                    {% set main_img = car.images|selectattr("is_main")|first or car.images[0] %}
                    <img src="{{ url_for('static', filename='uploads/cars/' + main_img.filename) }}" 
                         id="mainDisplayImage" class="img-fluid w-100 object-fit-cover" style="max-height: 500px;" alt="Car Image">
                {% else %}
                    <div class="bg-dark d-flex align-items-center justify-content-center" style="height: 400px;">
                        <i class="bi bi-camera fs-1 text-secondary"></i>
                    </div>
                {% endif %}
            </div>

            {% if car.images|length > 1 %}
            <div class="row g-2 mb-4">
                {% for img in car.images %}
                <div class="col-3 col-md-2">
                    <div class="ratio ratio-4x3 rounded-3 overflow-hidden border border-secondary border-opacity-50 cursor-pointer thumbnail-box">
                        <img src="{{ url_for('static', filename='uploads/cars/' + img.filename) }}" 
                             class="img-fluid object-fit-cover" 
                             onclick="document.getElementById('mainDisplayImage').src=this.src" alt="Thumbnail">
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="card bg-dark border-secondary border-opacity-25 rounded-4 p-4 shadow-sm">
                <h4 class="text-white fw-bold mb-3">Описание на обявата</h4>
                <p class="text-light opacity-75 lh-lg" style="white-space: pre-line;">
                    {{ car.description if car.description else "Продавачът не е предоставил допълнително описание." }}
                </p>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card bg-dark border-success border-opacity-25 rounded-4 p-4 shadow-lg mb-4 text-center">
                <h1 class="display-5 fw-bold text-success mb-1">
                    {{ "{:,.0f}".format(car.price) | replace(",", " ") }} <small class="fs-4">€</small>
                </h1>
                <p class="text-muted small mb-0">Публикувана на {{ car.created_at.strftime("%d.%m.%Y") }}</p>
            </div>

            <div class="card bg-dark border-secondary border-opacity-25 rounded-4 p-4 shadow-sm mb-4">
                <h5 class="text-white fw-bold mb-4 border-bottom border-secondary pb-2">Характеристики</h5>
                
                <div class="specs-grid">
                    <div class="d-flex justify-content-between mb-3 spec-item">
                        <span class="text-muted small"><i class="bi bi-speedometer2 me-2"></i>Пробег</span>
                        <span class="text-white fw-bold">{{ "{:,.0f}".format(car.mileage) | replace(",", " ") }} км</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 spec-item">
                        <span class="text-muted small"><i class="bi bi-fuel-pump me-2"></i>Гориво</span>
                        <span class="text-white fw-bold">{{ car.fuel }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 spec-item">
                        <span class="text-muted small"><i class="bi bi-gear-wide-connected me-2"></i>Трансмисия</span>
                        <span class="text-white fw-bold">{{ car.transmission }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 spec-item">
                        <span class="text-muted small"><i class="bi bi-lightning-charge me-2"></i>Мощност</span>
                        <span class="text-white fw-bold">{{ car.horsepower }} к.с.</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 spec-item">
                        <span class="text-muted small"><i class="bi bi-water me-2"></i>Двигател</span>
                        <span class="text-white fw-bold">{{ car.engine_size }} ccm</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 spec-item">
                        <span class="text-muted small"><i class="bi bi-palette me-2"></i>Цвят</span>
                        <span class="text-white fw-bold">{{ car.color }}</span>
                    </div>
                    <div class="d-flex justify-content-between spec-item">
                        <span class="text-muted small"><i class="bi bi-info-circle me-2"></i>Състояние</span>
                        <span class="badge {% if car.condition == 'Нова' %}bg-success text-dark{% else %}bg-secondary{% endif %}">
                            {{ car.condition }}
                        </span>
                    </div>
                </div>
            </div>

            <div class="card bg-dark border-secondary border-opacity-25 rounded-4 p-4 shadow-sm mb-4">
                <h5 class="text-white fw-bold mb-3">Контакт</h5>
                <div class="d-flex align-items-center mb-4 text-white">
                    <div class="bg-success rounded-circle d-flex align-items-center justify-content-center text-dark fw-bold" style="width: 45px; height: 45px;">
                        {{ car.author.username[0] | upper }}
                    </div>
                    <div class="ms-3">
                        <div class="fw-bold">{{ car.author.username }}</div>
                        <div class="text-muted small">Продавач</div>
                    </div>
                </div>
                
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-success btn-lg rounded-pill fw-bold text-dark" id="phoneButton">
                        <i class="bi bi-telephone-fill me-2"></i>Покажи телефон
                    </button>
                    <a href="mailto:{{ car.author.email }}" class="btn btn-outline-light rounded-pill">
                        <i class="bi bi-envelope me-2"></i>Имейл запитване
                    </a>
                </div>
            </div>

            {% if current_user.is_authenticated %}
                {% if current_user.id == car.user_id or current_user.is_admin %}
                <div class="d-grid gap-2">
                    <a href="{{ url_for('routes.delete_car', id=car.id) }}" 
                       class="btn btn-danger btn-lg rounded-pill fw-bold" 
                       onclick="return confirm('Наистина ли искате да изтриете тази обява?')">
                        <i class="bi bi-trash me-2"></i>Изтрий обявата
                    </a>
                    {% if current_user.is_admin and current_user.id != car.user_id %}
                        <small class="text-center text-warning mt-1">Административен панел</small>
                    {% endif %}
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<style>
    .spec-item span.text-white { color: #ffffff !important; }
    .thumbnail-box:hover { border-color: #00ff85 !important; transform: scale(1.05); }
    .main-image-container img { transition: opacity 0.2s; }
</style>

<script>
    // Телефонна логика
    const phoneBtn = document.getElementById('phoneButton');
    if (phoneBtn) {
        phoneBtn.addEventListener('click', function() {
            const phoneNumber = "{{ car.author.phone_number }}";
            this.innerHTML = `<i class="bi bi-telephone-outbound-fill me-2"></i> ${phoneNumber}`;
            this.classList.replace('btn-success', 'btn-outline-success');
            this.onclick = () => window.location.href = `tel:${phoneNumber}`;
        });
    }

    // Галерия логика
    document.querySelectorAll('.thumbnail-box img').forEach(img => {
        img.addEventListener('click', function() {
            const main = document.getElementById('mainDisplayImage');
            main.style.opacity = '0.5';
            setTimeout(() => {
                main.src = this.src;
                main.style.opacity = '1';
            }, 150);
        });
    });
</script>
{% endblock %}