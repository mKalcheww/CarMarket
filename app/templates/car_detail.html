{% extends "base.html" %}

{% block title %}{{ car.brand }} {{ car.model }} - CarMarket{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-dark p-3 rounded-4 border border-secondary border-opacity-25 shadow-sm">
            <li class="breadcrumb-item"><a href="{{ url_for('routes.index') }}" class="text-success text-decoration-none fw-bold">Начало</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('routes.search') }}" class="text-success text-decoration-none fw-bold">Обяви</a></li>
            <li class="breadcrumb-item active text-white opacity-75" aria-current="page">{{ car.brand }} {{ car.model }}</li>
        </ol>
    </nav>

    <div class="row g-4">
        <div class="col-lg-8">
            <div id="carCarousel" class="carousel slide rounded-4 overflow-hidden shadow-lg border border-secondary border-opacity-25 bg-dark mb-3" data-bs-ride="false">
                <div class="carousel-inner">
                    {% if car.images %}
                        {% for img in car.images %}
                        <div class="carousel-item {% if loop.first %}active{% endif %}">
                            <img src="{{ url_for('static', filename='uploads/cars/' + img.filename) }}" 
                                 class="d-block w-100 object-fit-cover main-display-img cursor-zoom-in" 
                                 style="height: 500px;" 
                                 alt="Car Image"
                                 onclick="openLightbox({{ loop.index0 }})">
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="carousel-item active">
                            <div class="bg-dark d-flex align-items-center justify-content-center" style="height: 500px;">
                                <i class="bi bi-camera fs-1 text-secondary"></i>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                {% if car.images|length > 1 %}
                <button class="carousel-control-prev" type="button" data-bs-target="#carCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Предишна</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Следваща</span>
                </button>
                {% endif %}
            </div>

            {% if car.images|length > 1 %}
            <div class="row g-2 mb-4 px-1">
                {% for img in car.images %}
                <div class="col-auto">
                    <div class="ratio ratio-4x3 rounded-3 overflow-hidden border border-secondary border-opacity-50 cursor-pointer thumbnail-box shadow-sm" 
                         style="width: 80px;" 
                         onclick="goToSlide({{ loop.index0 }})">
                        <img src="{{ url_for('static', filename='uploads/cars/' + img.filename) }}" 
                             class="w-100 h-100 object-fit-cover" alt="Thumbnail">
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="card bg-dark border-secondary border-opacity-25 rounded-4 p-4 shadow-sm mb-4">
                <h4 class="text-success fw-bold mb-3 border-bottom border-secondary pb-2">Описание</h4>
                <p class="custom-text-light opacity-75 lh-lg fs-5" style="white-space: pre-line;">
                    {{ car.description if car.description else "Няма допълнително описание." }}
                </p>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card bg-dark border-success border-opacity-50 rounded-4 p-4 shadow-lg mb-4 border-start border-4">
                <h2 class="text-white fw-bold mb-2">{{ car.brand }} {{ car.model }}</h2>
                <div class="d-flex align-items-baseline">
                    <h1 class="text-success fw-bold mb-0 me-2">{{ "{:,.0f}".format(car.price) | replace(",", " ") }}</h1>
                    <span class="text-success fs-3 fw-bold">€</span>
                </div>
            </div>

            <div class="card bg-dark border-secondary border-opacity-25 rounded-4 p-4 shadow-sm mb-4">
                <h5 class="text-white fw-bold mb-4 border-bottom border-secondary pb-2">Детайли</h5>
                <div class="specs-list">
                    <div class="d-flex justify-content-between mb-3 pb-2 border-bottom border-secondary border-opacity-10 text-white">
                        <span class="text-muted"><i class="bi bi-speedometer2 me-2 text-success"></i>Пробег</span>
                        <span class="fw-bold">{{ car.mileage }} км</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 pb-2 border-bottom border-secondary border-opacity-10 text-white">
                        <span class="text-muted"><i class="bi bi-fuel-pump me-2 text-success"></i>Гориво</span>
                        <span class="fw-bold">{{ car.fuel }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 pb-2 border-bottom border-secondary border-opacity-10 text-white">
                        <span class="text-muted"><i class="bi bi-gear-wide-connected me-2 text-success"></i>Трансмисия</span>
                        <span class="fw-bold">{{ car.transmission }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 pb-2 border-bottom border-secondary border-opacity-10 text-white">
                        <span class="text-muted"><i class="bi bi-palette me-2 text-success"></i>Цвят</span>
                        <span class="fw-bold">{{ car.color }}</span>
                    </div>
                </div>
            </div>

            <div class="card bg-dark border-secondary border-opacity-25 rounded-4 p-4 shadow-sm mb-4">
                <div class="d-flex align-items-center mb-4">
                    <div class="bg-success rounded-circle d-flex align-items-center justify-content-center text-dark fw-bold shadow" style="width: 55px; height: 55px;">
                        {{ car.author.username[0] | upper }}
                    </div>
                    <div class="ms-3">
                        <div class="fw-bold fs-5 text-white">{{ car.author.username }}</div>
                        <div class="text-success small">Продавач</div>
                    </div>
                </div>
                <div class="d-grid gap-3">
                    <button type="button" class="btn btn-success btn-lg rounded-pill fw-bold text-dark py-3" id="phoneButton">Покажи телефон</button>
                    <button type="button" class="btn btn-outline-light btn-lg rounded-pill py-3 fw-bold" id="emailButton">Покажи имейл</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="lightboxModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body p-0 position-relative text-center">
                <img src="" id="lightboxImage" class="img-fluid rounded shadow-lg" style="max-height: 90vh;">
                
                <button class="btn btn-link text-white position-absolute top-50 start-0 translate-middle-y fs-1" onclick="changeLightbox(-1)">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button class="btn btn-link text-white position-absolute top-50 end-0 translate-middle-y fs-1" onclick="changeLightbox(1)">
                    <i class="bi bi-chevron-right"></i>
                </button>
                
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
            </div>
        </div>
    </div>
</div>

<style>
    body { background-color: #0b0c10 !important; }
    .custom-text-light { color: #e0e0e0 !important; }
    .text-muted { color: #9da5ad !important; }
    .thumbnail-box { transition: 0.2s; cursor: pointer; }
    .thumbnail-box:hover { border-color: #198754 !important; }
    .cursor-zoom-in { cursor: zoom-in; }
    .carousel-control-prev, .carousel-control-next { width: 8%; background: rgba(0,0,0,0.3); }
</style>

<script>
    // Масив с всички URL адреси на снимките (предадени от Flask)
    const allImages = [
        {% for img in car.images %}
            "{{ url_for('static', filename='uploads/cars/' + img.filename) }}"{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    let currentImageIndex = 0;

    // Отваряне на Lightbox
    function openLightbox(index) {
        currentImageIndex = index;
        updateLightboxImage();
        const modal = new bootstrap.Modal(document.getElementById('lightboxModal'));
        modal.show();
    }

    // Смяна на снимка в Lightbox
    function changeLightbox(direction) {
        currentImageIndex += direction;
        if (currentImageIndex >= allImages.length) currentImageIndex = 0;
        if (currentImageIndex < 0) currentImageIndex = allImages.length - 1;
        updateLightboxImage();
    }

    function updateLightboxImage() {
        document.getElementById('lightboxImage').src = allImages[currentImageIndex];
    }

    // Навигация на основния Carousel
    function goToSlide(index) {
        const carousel = new bootstrap.Carousel(document.getElementById('carCarousel'));
        carousel.to(index);
    }

    // Поддръжка на клавиатура (стрелки) за Lightbox
    document.addEventListener('keydown', function(e) {
        const modalEl = document.getElementById('lightboxModal');
        if (modalEl.classList.contains('show')) {
            if (e.key === "ArrowLeft") changeLightbox(-1);
            if (e.key === "ArrowRight") changeLightbox(1);
        }
    });

    // Бутони за контакт
    document.getElementById('phoneButton')?.addEventListener('click', function() {
        this.innerText = "{{ car.author.phone_number }}";
        this.classList.replace('btn-success', 'btn-outline-success');
    });

    document.getElementById('emailButton')?.addEventListener('click', function() {
        this.innerText = "{{ car.author.email }}";
        this.classList.replace('btn-outline-light', 'btn-outline-success');
    });
</script>
{% endblock %}