{% extends "base.html" %}
{% block title %}{{ car.brand }} {{ car.model }} ({{ car.year }}){% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <!-- ГЛАВНА СНИМКА -->
        <div class="col-lg-8 mb-4">
            {% set main_img = car.images | selectattr("is_main") | first %}
            {% if main_img %}
                <img src="{{ url_for('static', filename='uploads/cars/' + main_img.filename) }}"
                     class="img-fluid rounded shadow-lg w-100 car-thumbnail"
                     style="height: 500px; object-fit: cover; cursor: pointer;"
                     alt="{{ car.brand }} {{ car.model }}"
                     id="main-image">
            {% else %}
                <img src="{{ url_for('static', filename='placeholder.jpg') }}"
                     class="img-fluid rounded shadow-lg w-100"
                     style="height: 500px; object-fit: cover;"
                     alt="Няма снимка">
            {% endif %}

            <!-- МАЛКИ СНИМКИ -->
            {% if car.images %}
            <div class="row mt-3 g-2">
                {% for img in car.images %}
                <div class="col-3 col-md-2">
                    <img src="{{ url_for('static', filename='uploads/cars/' + img.filename) }}"
                         class="img-thumbnail cursor-pointer border car-thumbnail {% if img.is_main %}border-success border-3{% endif %}"
                         style="height: 90px; object-fit: cover;"
                         alt="Снимка {{ loop.index }}">
                </div>
                {% endfor %}
                </div> <!-- ← ТОЗИ </div> ЛИПСВАШЕ! -->
            {% endif %}
        </div>

        <!-- ИНФОРМАЦИЯ -->
        <div class="col-lg-4">
            <div class="card shadow-lg h-100">
                <div class="card-body">
                    <h1 class="text-success fw-bold">{{ car.brand }} {{ car.model }}</h1>
                    <h3 class="text-primary">{{ car.year }} г. • {{ "{:,.0f}".format(car.price) }} лв.</h3>
                    <hr>
                    <p><strong>Конски сили:</strong> {{ car.horsepower or "Не е посочено" }}</p>
                    <p><strong>Гориво:</strong> {{ car.fuel }}</p>
                    <p><strong>Публикувана от:</strong> {{ current_user.username }}</p>
                    <p><strong>Дата:</strong> {{ car.created_at.strftime('%d.%m.%Y') }}</p>
                    <hr>
                    <h5>Описание:</h5>
                    <p>{{ car.description | replace('\n', '<br>') | safe }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- LIGHTBOX -->
<div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="close-btn" onclick="event.stopPropagation(); closeLightbox();">×</span>
    <span class="prev-btn" onclick="event.stopPropagation(); changeSlide(-1);"><</span>
    <span class="next-btn" onclick="event.stopPropagation(); changeSlide(1);">></span>
    <img id="lightbox-img" src="" alt="Голяма снимка">
    <div id="counter" class="lightbox-counter">1 / 1</div>
</div>

<style>
.lightbox {
    display: none;
    position: fixed;
    z-index: 9999;
    inset: 0;
    background-color: rgba(0,0,0,0.95);
    justify-content: center;
    align-items: center;
    cursor: pointer;
}
.lightbox img { max-width: 90%; max-height: 85vh; border-radius: 8px; }
.close-btn, .prev-btn, .next-btn {
    position: absolute;
    font-size: 40px;
    color: white;
    cursor: pointer;
    user-select: none;
    z-index: 10000;
    padding: 10px;
}
.close-btn { top: 20px; right: 30px; }
.prev-btn { top: 50%; left: 30px; transform: translateY(-50%); }
.next-btn { top: 50%; right: 30px; transform: translateY(-50%); }
.lightbox-counter {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 18px;
}
.cursor-pointer { cursor: pointer; }
</style>

<script>
// ЧИСТ VANILLA JS – НИКАКВА JINJA В JS!
const thumbnails = document.querySelectorAll('.car-thumbnail');
const imageUrls = Array.from(thumbnails).map(img => img.src);

let currentIndex = 0;

function openLightbox(index) {
    if (imageUrls.length === 0) return;
    currentIndex = index;
    document.getElementById('lightbox').style.display = 'flex';
    document.getElementById('lightbox-img').src = imageUrls[currentIndex];
    updateCounter();
}

function closeLightbox() {
    document.getElementById('lightbox').style.display = 'none';
}

function changeSlide(step) {
    currentIndex = (currentIndex + step + imageUrls.length) % imageUrls.length;
    document.getElementById('lightbox-img').src = imageUrls[currentIndex];
    updateCounter();
}

function updateCounter() {
    document.getElementById('counter').textContent = `${currentIndex + 1} / ${imageUrls.length || 1}`;
}

// Клик върху всяка снимка (голяма или малка)
thumbnails.forEach((thumb, index) => {
    thumb.addEventListener('click', (e) => {
        e.stopPropagation();
        openLightbox(index);
    });
});

// Клавиши
document.addEventListener('keydown', e => {
    if (document.getElementById('lightbox').style.display === 'flex') {
        if (e.key === 'ArrowLeft') changeSlide(-1);
        if (e.key === 'ArrowRight') changeSlide(1);
        if (e.key === 'Escape') closeLightbox();
    }
});
</script>
{% endblock %}