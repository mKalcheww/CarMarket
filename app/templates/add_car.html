{% extends "base.html" %}
{% block title %}Качи обява – CarMarket{% endblock %}

{% block content %}
<div class="container py-5 min-vh-100">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h1 class="display-5 fw-bold text-center mb-5 text-success">Публикувай обява</h1>

            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-5">
                    <form method="POST" enctype="multipart/form-data" id="carForm" novalidate>
                        {{ form.hidden_tag() }}

                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Марка <span class="text-danger">*</span></label>
                                {{ form.brand(class="form-select form-select-lg shadow-sm", id="brand-select") }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Модел <span class="text-danger">*</span></label>
                                {{ form.model(class="form-select form-select-lg shadow-sm", id="model-select") }}
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold">Година <span class="text-danger">*</span></label>
                                {{ form.year(class="form-select form-select-lg shadow-sm") }}
                            </div>
                            <div class="col-md-8">
                                <label class="form-label fw-bold">Цена (€) <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    {{ form.price(class="form-control form-control-lg shadow-sm", placeholder="25990") }}
                                    <span class="input-group-text bg-success text-white fw-bold">€</span>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold">Конски сили <span class="text-danger">*</span></label>
                                {{ form.horsepower(class="form-control form-control-lg shadow-sm") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Кубатура <span class="text-danger">*</span></label>
                                {{ form.engine_size(class="form-control form-control-lg shadow-sm") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Гориво <span class="text-danger">*</span></label>
                                {{ form.fuel_type(class="form-select form-select-lg shadow-sm") }}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Пробег (км) <span class="text-danger">*</span></label>
                                {{ form.mileage(class="form-control form-control-lg shadow-sm") }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Скоростна кутия <span class="text-danger">*</span></label>
                                {{ form.transmission(class="form-select form-select-lg shadow-sm") }}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Цвят <span class="text-danger">*</span></label>
                                {{ form.color(class="form-control form-control-lg shadow-sm") }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Брой врати <span class="text-danger">*</span></label>
                                {{ form.doors(class="form-select form-select-lg shadow-sm") }}
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Състояние <span class="text-danger">*</span></label>
                                {{ form.condition(class="form-select form-select-lg shadow-sm") }}
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Описание</label>
                                {{ form.description(class="form-control shadow-sm", rows="4") }}
                            </div>

                            <div class="col-12 mt-5">
    <label class="form-label fw-bold text-success fs-4">Снимки</label>
    
    <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
    
    <div id="dropZone" class="border border-3 border-success rounded-4 p-5 text-center bg-dark bg-opacity-50" style="cursor: pointer;">
        <i class="bi bi-cloud-upload fs-1 text-success"></i>
        <p class="mt-3 fw-bold text-success">Първо попълнете данните, после качете снимки</p>
        <small class="text-muted">JPG, PNG, WebP • до 5MB на снимка</small>
    </div>
    
    <div id="preview" class="row mt-4 g-3"></div>
</div>

                            <div class="col-12 text-center mt-5">
                                {{ form.submit(class="btn btn-success btn-lg px-5 py-3 fw-bold", id="publishBtn") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    body { background-color: #0f0f0f !important; color: #e0e0e0 !important; }
    .card { background: #161b22 !important; border: 1px solid #333 !important; }
    .form-control, .form-select { background-color: #0d1117 !important; border: 1px solid #30363d !important; color: #fff !important; }
    .form-label { color: #00ff85 !important; }
    #dropZone { border: 3px dashed #00ff85 !important; transition: 0.3s; }
    #dropZone:hover { background: rgba(0,255,133,0.1) !important; }
    .preview-card { position: relative; border-radius: 12px; overflow: hidden; border: 1px solid #00ff85; }
    .preview-img { height: 160px; width: 100%; object-fit: cover; }
    .input-group-text { background: #00ff85 !important; color: #000 !important; border: none; }
</style>

<script>
    let carId = null;
    let isUploading = false;

    // Елементи
    const brandSelect = document.getElementById('brand-select');
    const modelSelect = document.getElementById('model-select');
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    // 1. Динамични модели
    brandSelect.addEventListener('change', function() {
        const brand = this.value;
        modelSelect.innerHTML = '<option value="">Зареждане...</option>';
        if (brand) {
            fetch(`/api/models/${encodeURIComponent(brand)}`)
                .then(r => r.json())
                .then(data => {
                    modelSelect.innerHTML = '<option value="">Изберете модел</option>';
                    data.forEach(m => {
                        let opt = document.createElement('option');
                        opt.value = opt.textContent = m;
                        modelSelect.appendChild(opt);
                    });
                });
        }
    });

    // 2. Валидация на формата (Проверява дали ВСИЧКИ полета са попълнени)
    function validateForm() {
        // Списък с ID-тата на всички задължителни полета
        // Забележка: Flask-WTF генерира ID-та съвпадащи с имената на полетата (напр. year, horsepower)
        const requiredFields = [
            'brand-select', 'model-select', 'year', 'price', 
            'horsepower', 'engine_size', 'fuel_type', 
            'mileage', 'transmission', 'color', 'doors', 'condition'
        ];

        for (let id of requiredFields) {
            let el = document.getElementById(id);
            // Ако не намерим елемента по ID, търсим по name (за всеки случай)
            if (!el) el = document.querySelector(`[name="${id}"]`);
            
            if (!el || !el.value) {
                // Връщаме името на полето, което липсва
                let label = el?.previousElementSibling?.innerText || id;
                return `Моля, попълнете полето: "${label}", преди да качите снимки!`;
            }
        }
        return null; // Всичко е наред
    }

    // 3. Основна функция за качване
    async function uploadFiles(files) {
        if (isUploading || files.length === 0) return;
        
        console.log("Започва обработка на файлове...");

        // Ако нямаме Car ID, значи трябва да създадем обявата първо
        if (!carId) {
            // Първо проверяваме дали формата е попълнена
            const error = validateForm();
            if (error) {
                alert(error);
                // Изчистваме инпута, за да може да се избере същия файл пак
                fileInput.value = ''; 
                return;
            }

            isUploading = true;
            const formData = new FormData(document.getElementById('carForm'));
            
            try {
                console.log("Изпращане на заявка за създаване на обява...");
                const response = await fetch("{{ url_for('routes.add_car') }}", {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }, // Важно за routes.py
                    body: formData
                });
                
                const data = await response.json();

                if (response.ok) {
                    console.log("Обявата създадена успешно! ID:", data.car_id);
                    carId = data.car_id;
                    // Скриваме полетата, за да не ги променя потребителят докато качва
                    document.getElementById('carForm').classList.add('opacity-75');
                } else {
                    // ТУК ПОКАЗВАМЕ ТОЧНАТА ГРЕШКА ОТ СЪРВЪРА
                    console.error("Грешка от сървъра:", data);
                    let msg = "Сървърът върна грешка:\n";
                    if (data.errors) {
                        for (let field in data.errors) {
                            msg += `• ${data.errors[field].join(', ')}\n`;
                        }
                    }
                    alert(msg);
                    isUploading = false;
                    fileInput.value = '';
                    return;
                }
            } catch (err) {
                console.error("Мрежова грешка:", err);
                alert("Възникна грешка при свързване със сървъра.");
                isUploading = false;
                fileInput.value = '';
                return;
            }
        }

        // 4. Качване на самите снимки една по една
        isUploading = true;
        for (const file of files) {
            const imageData = new FormData();
            imageData.append('file', file);

            try {
                const imgResponse = await fetch(`/upload_image/${carId}`, {
                    method: 'POST',
                    body: imageData
                });

                if (imgResponse.ok) {
                    const result = await imgResponse.json();
                    const preview = document.getElementById('preview');
                    const div = document.createElement('div');
                    div.className = 'col-md-3 col-6 fade-in';
                    div.innerHTML = `
                        <div class="preview-card shadow-sm">
                            <img src="${result.url}" class="preview-img">
                            <div class="bg-success text-white text-center py-1 small fw-bold">
                                <i class="bi bi-check-circle me-1"></i>Качена
                            </div>
                        </div>`;
                    preview.appendChild(div);
                } else {
                    console.error("Грешка при качване на снимка");
                }
            } catch (err) {
                console.error(err);
            }
        }
        isUploading = false;
        fileInput.value = ''; // Ресетваме инпута
    }

    // 5. Event Listeners (Събития)
    
    // Клик върху зоната -> отваря файловия мениджър
    dropZone.addEventListener('click', () => {
        fileInput.click();
    });

    // Избор на файл от мениджъра
    fileInput.addEventListener('change', (e) => {
        console.log("Файлове избрани:", e.target.files.length);
        uploadFiles(e.target.files);
    });

    // Drag & Drop ефекти
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.background = "rgba(0,255,133,0.15)";
        dropZone.style.transform = "scale(1.02)";
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.style.background = "";
        dropZone.style.transform = "scale(1)";
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.background = "";
        dropZone.style.transform = "scale(1)";
        console.log("Файлове пуснати (Drag&Drop):", e.dataTransfer.files.length);
        uploadFiles(e.dataTransfer.files);
    });

    // Финално натискане на бутона "Публикувай"
    document.getElementById('carForm').addEventListener('submit', function(e) {
        if (!carId) {
            e.preventDefault();
            alert("Моля, качете поне една снимка преди да публикувате!");
        } else {
            // Ако вече имаме carId, просто пренасочваме към колата
            e.preventDefault();
            window.location.href = `/car/${carId}`;
        }
    });
</script>
{% endblock %}