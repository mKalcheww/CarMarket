{% extends "base.html" %}
{% block title %}Качи обява – CarMarket{% endblock %}

{% block content %}
<div class="container py-5 min-vh-100">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            <h1 class="display-5 fw-bold text-center mb-5 text-success">Публикувай обява</h1>

            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-5">

                    <form method="POST" enctype="multipart/form-data" id="carForm" novalidate>
                        {{ form.hidden_tag() }}

                        <div class="row g-4">

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Марка <span class="text-danger">*</span></label>
                                {{ form.brand(class="form-select form-select-lg shadow-sm", id="brand-select") }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Модел <span class="text-danger">*</span></label>
                                {{ form.model(class="form-select form-select-lg shadow-sm", id="model-select") }}
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold">Година <span class="text-danger">*</span></label>
                                {{ form.year(class="form-select form-select-lg shadow-sm") }}
                            </div>
                            <div class="col-md-8">
                                <label class="form-label fw-bold">Цена (€) <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    {{ form.price(class="form-control form-control-lg shadow-sm", placeholder="25990") }}
                                    <span class="input-group-text bg-success text-white fw-bold">€</span>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold">Конски сили <span class="text-danger">*</span></label>
                                {{ form.horsepower(class="form-control form-control-lg shadow-sm") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Кубатура (ccm) <span class="text-danger">*</span></label>
                                {{ form.engine_size(class="form-control form-control-lg shadow-sm") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Гориво <span class="text-danger">*</span></label>
                                {{ form.fuel_type(class="form-select form-select-lg shadow-sm") }}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Пробег (км) <span class="text-danger">*</span></label>
                                {{ form.mileage(class="form-control form-control-lg shadow-sm", placeholder="145000") }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Скоростна кутия <span class="text-danger">*</span></label>
                                {{ form.transmission(class="form-select form-select-lg shadow-sm") }}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Цвят <span class="text-danger">*</span></label>
                                {{ form.color(class="form-control form-control-lg shadow-sm", placeholder="Черен металик") }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Брой врати <span class="text-danger">*</span></label>
                                {{ form.doors(class="form-select form-select-lg shadow-sm") }}
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Състояние <span class="text-danger">*</span></label>
                                {{ form.condition(class="form-select form-select-lg shadow-sm") }}
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Описание</label>
                                {{ form.description(class="form-control shadow-sm", rows="6", placeholder="Перфектно състояние, един собственик, пълна сервизна история...") }}
                            </div>

                            <div class="col-12 mt-5">
                                <label class="form-label fw-bold text-success fs-4">Снимки (задължително поне една)</label>
                                
                                <div id="dropZone" class="border border-3 border-success rounded-4 p-5 text-center bg-dark bg-opacity-50" style="cursor:pointer; transition:all .4s; min-height: 200px;">
                                    <i class="bi bi-cloud-upload fs-1 text-success"></i>
                                    <p class="mt-3 fw-bold text-success">Кликни или пусни снимки тук</p>
                                    <small class="text-muted">Макс. 10 снимки • JPG, PNG, WebP • до 5MB</small>
                                </div>

                                <div id="preview" class="row mt-4 g-3"></div>
                            </div>

                            <div class="col-12 text-center mt-5">
                                {{ form.submit(class="btn btn-success btn-lg px-5 py-3 fw-bold shadow-lg fs-4", id="publishBtn") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    body { background-color: #0f0f0f !important; color: #e0e0e0 !important; }
    .card { background: linear-gradient(145deg, #1a1a1a, #121212) !important; border: 1px solid #333 !important; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.8); }
    .form-control, .form-select { background-color: #222 !important; border: 1px solid #444 !important; color: #fff !important; border-radius: 12px !important; padding: 12px 16px !important; font-size: 1.1rem; }
    .form-control::placeholder { color: #888 !important; }
    .form-control:focus, .form-select:focus { background-color: #2a2a2a !important; border-color: #00ff85 !important; box-shadow: 0 0 0 0.25rem rgba(0,255,133,0.3) !important; }
    .input-group-text { background: linear-gradient(45deg, #00bf63, #00ff85) !important; color: white !important; border: none !important; font-weight: bold; }
    .form-label { color: #00ff85 !important; font-weight: 600; margin-bottom: 8px; }
    #dropZone { background: #1a1a1a !important; border: 3px dashed #00ff85 !important; border-radius: 20px; }
    #dropZone:hover { background: #222 !important; border-color: #00ff85 !important; box-shadow: 0 0 30px rgba(0,255,133,0.4); transform: translateY(-8px); }
    .btn-success { background: linear-gradient(45deg, #00bf63, #00ff85) !important; border: none !important; padding: 16px 50px !important; font-size: 1.4rem !important; font-weight: bold; border-radius: 50px; }
    .btn-success:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,255,133,0.6); }
    .preview-img { height: 220px; object-fit: cover; border-radius: 12px; border: 2px solid #00ff85; }
</style>

<script>
    // 1. ЛОГИКА ЗА ДИНАМИЧНИ МОДЕЛИ
    document.getElementById('brand-select').addEventListener('change', function() {
        const brand = this.value;
        const modelSelect = document.getElementById('model-select');
        modelSelect.innerHTML = '<option value="">Зареждане...</option>';
        
        if (brand) {
            fetch(`/api/models/${encodeURIComponent(brand)}`)
                .then(response => response.json())
                .then(models => {
                    modelSelect.innerHTML = '<option value="">Изберете модел</option>';
                    models.forEach(m => {
                        let opt = document.createElement('option');
                        opt.value = m;
                        opt.textContent = m;
                        modelSelect.appendChild(opt);
                    });
                });
        } else {
            modelSelect.innerHTML = '<option value="">Първо изберете марка</option>';
        }
    });

    // 2. AJAX КАЧВАНЕ НА СНИМКИ (Твоята съществуваща логика)
    let carId = null;
    let isUploading = false;

    async function processFiles(files) {
        if (isUploading) return;
        isUploading = true;
        
        const fileArray = Array.from(files);

        for (const file of fileArray) {
            if (!carId) {
                const csrfToken = document.querySelector('input[name="csrf_token"]').value; 
                const formData = new FormData(document.getElementById('carForm'));
                formData.delete('submit');
                formData.append('csrf_token', csrfToken);
                
                // Проверка на полетата
                const requiredFields = ['brand', 'model', 'year', 'price', 'horsepower', 'engine_size', 'fuel_type', 'mileage', 'transmission', 'color', 'doors', 'condition'];
                let allFilled = true;
                for (const f of requiredFields) {
                    if (!formData.get(f)) { allFilled = false; break; }
                }

                if (!allFilled) {
                    alert('Попълни първо данните за колата, за да качиш снимки!');
                    isUploading = false;
                    return;
                }

                const response = await fetch('/add_car', {
                    method: 'POST',
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    body: formData
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    alert('Грешка: ' + JSON.stringify(err.errors));
                    isUploading = false;
                    return;
                }
                
                const data = await response.json();
                carId = data.car_id;
            }

            const uploadData = new FormData();
            uploadData.append('file', file);

            const upRes = await fetch(`/upload_image/${carId}`, { method: 'POST', body: uploadData });

            if (upRes.ok) {
                const res = await upRes.json();
                const preview = document.getElementById('preview');
                const col = document.createElement('div');
                col.className = 'col-md-4 col-lg-3 mb-3';
                col.innerHTML = `
                    <div class="rounded-3 overflow-hidden shadow-lg border border-success border-opacity-50">
                        <img src="${res.url}" class="w-100 preview-img">
                        <div class="bg-dark text-center py-2">
                            <small class="text-white">${file.name.substring(0,15)}...</small>
                        </div>
                    </div>`;
                preview.appendChild(col);
            }
        }
        isUploading = false;
    }

    // Drag & Drop / Click Handlers (Твоите оригинални)
    const dropZone = document.getElementById('dropZone');
    dropZone.onclick = () => {
        const input = document.createElement('input');
        input.type = 'file'; input.multiple = true; input.accept = 'image/*';
        input.onchange = e => processFiles(e.target.files);
        input.click();
    };

    dropZone.ondrop = e => { e.preventDefault(); processFiles(e.dataTransfer.files); };
    dropZone.ondragover = e => { e.preventDefault(); dropZone.style.backgroundColor = 'rgba(0,255,133,0.15)'; };
    dropZone.ondragleave = () => { dropZone.style.backgroundColor = ''; };

    document.getElementById('carForm').onsubmit = e => {
        e.preventDefault();
        if (!carId) { alert('Качи снимки!'); return; }
        location.href = `/car/${carId}`;
    };
</script>
{% endblock %}