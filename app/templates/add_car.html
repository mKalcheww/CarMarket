{% extends "base.html" %}
{% block title %}Качи обява – CarMarket{% endblock %}

{% block content %}
<div class="container py-5 min-vh-100">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            <h1 class="display-5 fw-bold text-center mb-5 text-success">Публикувай обява</h1>

            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-body p-5">

                    <form method="POST" enctype="multipart/form-data" id="carForm" novalidate>
                        {{ form.hidden_tag() }}

                        <div class="row g-4">

                            <!-- ПОЛЕТАТА -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Марка <span class="text-danger">*</span></label>
                                {{ form.brand(class="form-control form-control-lg shadow-sm", placeholder="BMW, Audi, Mercedes...") }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Модел <span class="text-danger">*</span></label>
                                {{ form.model(class="form-control form-control-lg shadow-sm", placeholder="320d, A4, E220...") }}
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold">Година <span class="text-danger">*</span></label>
                                {{ form.year(class="form-control form-control-lg shadow-sm") }}
                            </div>
                            <div class="col-md-8">
                                <label class="form-label fw-bold">Цена (лв.) <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    {{ form.price(class="form-control form-control-lg shadow-sm", placeholder="25990") }}
                                    <span class="input-group-text bg-success text-white fw-bold">лв.</span>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-bold">Конски сили <span class="text-danger">*</span></label>
                                {{ form.horsepower(class="form-control form-control-lg shadow-sm") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Кубатура (ccm) <span class="text-danger">*</span></label>
                                {{ form.engine_size(class="form-control form-control-lg shadow-sm") }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Гориво <span class="text-danger">*</span></label>
                                {{ form.fuel(class="form-select form-select-lg shadow-sm") }}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Пробег (км) <span class="text-danger">*</span></label>
                                {{ form.mileage(class="form-control form-control-lg shadow-sm", placeholder="145000") }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Скоростна кутия <span class="text-danger">*</span></label>
                                {{ form.transmission(class="form-select form-select-lg shadow-sm") }}
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Цвят <span class="text-danger">*</span></label>
                                {{ form.color(class="form-control form-control-lg shadow-sm", placeholder="Черен металик") }}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Брой врати <span class="text-danger">*</span></label>
                                {{ form.doors(class="form-select form-select-lg shadow-sm") }}
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Състояние <span class="text-danger">*</span></label>
                                {{ form.condition(class="form-select form-select-lg shadow-sm") }}
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Описание</label>
                                {{ form.description(class="form-control shadow-sm", rows="6", placeholder="Перфектно състояние, един собственик, пълна сервизна история...") }}
                            </div>

                            <!-- КАЧВАНЕ НА СНИМКИ -->
                            <div class="col-12 mt-5">
                                <label class="form-label fw-bold text-success fs-4">Снимки (задължително поне една)</label>
                                
                                <div id="dropZone" class="border border-3 border-success rounded-4 p-5 text-center bg-dark bg-opacity-50" style="cursor:pointer; transition:all .4s; min-height: 200px;">
                                    <i class="bi bi-cloud-upload fs-1 text-success"></i>
                                    <p class="mt-3 fw-bold text-success">Кликни или пусни снимки тук</p>
                                    <small class="text-muted">Макс. 10 снимки • JPG, PNG, WebP • до 5MB</small>
                                </div>

                                <!-- ПРЕВЮ НА КАЧЕНИТЕ СНИМКИ -->
                                <div id="preview" class="row mt-4 g-3"></div>
                            </div>

                            <div class="col-12 text-center mt-5">
                                {{ form.submit(class="btn btn-success btn-lg px-5 py-3 fw-bold shadow-lg fs-4", id="publishBtn") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- КРАСИВ ЧЕРЕН СТИЛ -->
<style>
    body { background-color: #0f0f0f !important; color: #e0e0e0 !important; }
    .card { background: linear-gradient(145deg, #1a1a1a, #121212) !important; border: 1px solid #333 !important; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.8); }
    .form-control, .form-select { background-color: #222 !important; border: 1px solid #444 !important; color: #fff !important; border-radius: 12px !important; padding: 12px 16px !important; font-size: 1.1rem; }
    .form-control::placeholder { color: #888 !important; }
    .form-control:focus, .form-select:focus { background-color: #2a2a2a !important; border-color: #00ff85 !important; box-shadow: 0 0 0 0.25rem rgba(0,255,133,0.3) !important; }
    .input-group-text { background: linear-gradient(45deg, #00bf63, #00ff85) !important; color: white !important; border: none !important; font-weight: bold; }
    .form-label { color: #00ff85 !important; font-weight: 600; margin-bottom: 8px; }
    #dropZone { background: #1a1a1a !important; border: 3px dashed #00ff85 !important; border-radius: 20px; }
    #dropZone:hover { background: #222 !important; border-color: #00ff85 !important; box-shadow: 0 0 30px rgba(0,255,133,0.4); transform: translateY(-8px); }
    .btn-success { background: linear-gradient(45deg, #00bf63, #00ff85) !important; border: none !important; padding: 16px 50px !important; font-size: 1.4rem !important; font-weight: bold; border-radius: 50px; }
    .btn-success:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,255,133,0.6); }
    .preview-img { height: 220px; object-fit: cover; border-radius: 12px; border: 2px solid #00ff85; }
</style>

<!-- 100% РАБОТЕЩ JS С ПРЕВЮ -->
<script>
    let carId = null;

    async function uploadFile(file) {
        // ПЪРВО СЪЗДАВАМЕ ОБЯВАТА
        if (!carId) {
            const formData = new FormData(document.getElementById('carForm'));
            formData.delete('submit');
            formData.delete('csrf_token'); 

            const response = await fetch('/add_car', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            });

            if (!response.ok) {
                alert('Попълни всички задължителни полета!');
                return;
            }

            const data = await response.json();
            carId = data.car_id;
        }

        // КАЧВАМЕ СНИМКАТА
        const uploadData = new FormData();
        uploadData.append('file', file);

        const uploadResponse = await fetch(`/upload_image/${carId}`, {
            method: 'POST',
            body: uploadData
        });

        if (uploadResponse.ok) {
            const result = await uploadResponse.json();
            const preview = document.getElementById('preview');
            const col = document.createElement('div');
            col.className = 'col-md-4 col-lg-3 mb-3';
            col.innerHTML = `
                <div class="rounded-3 overflow-hidden shadow-lg border border-success border-opacity-50">
                    <img src="${result.url}" class="w-100" style="height:220px; object-fit:cover;">
                    <div class="bg-dark bg-dark bg-opacity-90 text-center py-2">
                        <small class="text-white">${file.name}</small>
                        ${result.is_main ? '<span class="badge bg-success ms-2">Главна</span>' : ''}
                    </div>
                </div>
            `;
            preview.appendChild(col);
        }
    }

    // Drag & Drop
    const dropZone = document.getElementById('dropZone');
    dropZone.onclick = () => document.querySelector('#fileInput')?.click() || (() => {
        const input = document.createElement('input');
        input.type = 'file';
        input.multiple = true;
        input.accept = 'image/*';
        input.id = 'fileInput';
        input.style.display = 'none';
        document.body.appendChild(input);
        input.onchange = e => {
            [...e.target.files].forEach(uploadFile);
        };
        input.click();
    })();

    dropZone.ondrop = e => {
        e.preventDefault();
        dropZone.style.backgroundColor = '';
        [...e.dataTransfer.files].forEach(uploadFile);
    };

    dropZone.ondragover = dropZone.ondragenter = e => {
        e.preventDefault();
        dropZone.style.backgroundColor = 'rgba(0,255,133,0.15)';
    };

    dropZone.ondragleave = () => {
        dropZone.style.backgroundColor = '';
    };

    // Публикуване
    document.getElementById('carForm').onsubmit = e => {
        e.preventDefault();
        if (!carId) {
            alert('Качи поне една снимка!');
            return;
        }
        location.href = `/car/${carId}`;
    };
</script>

{% endblock %}