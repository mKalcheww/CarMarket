{% extends "base.html" %}
{% block title %}Търсене – CarMarket{% endblock %}

{% block content %}
<div class="container py-5 min-vh-100">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            
            <h1 class="display-5 fw-bold text-center mb-5 text-success">Търсене на автомобили</h1>

            <div class="card shadow-lg border-0 rounded-4 mb-5">
                <div class="card-body p-4">
                    <form method="GET" action="{{ url_for('main.search') }}" id="searchForm">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Марка</label>
                                {{ form.brand(class="form-select form-select-lg shadow-sm", id="brand-search") }}
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Модел</label>
                                {{ form.model(class="form-select form-select-lg shadow-sm", id="model-search") }}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Мин. цена (€)</label>
                                {{ form.min_price(class="form-control form-control-lg shadow-sm", placeholder="0") }}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-bold">Макс. цена (€)</label>
                                {{ form.max_price(class="form-control form-control-lg shadow-sm", placeholder="Без лимит") }}
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-success btn-lg w-100 fw-bold shadow-sm">
                                    <i class="bi bi-search me-2"></i>Търси
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div id="resultsArea">
                {% if cars %}
                    <div class="row g-4">
                        {% for car in cars %}
                        <div class="col-md-4 col-lg-3">
                            <div class="card h-100 car-card border-0 rounded-4 overflow-hidden">
                                <div class="position-relative">
                                    {% if car.images %}
                                        <img src="{{ url_for('static', filename='uploads/cars/' + car.images[0].image_file) }}" class="card-img-top car-img" alt="{{ car.brand }}">
                                    {% else %}
                                        <img src="https://via.placeholder.com/400x300?text=No+Image" class="card-img-top car-img" alt="Няма снимка">
                                    {% endif %}
                                    <div class="price-badge">{{ car.price }} €</div>
                                </div>
                                <div class="card-body p-3">
                                    <h5 class="card-title fw-bold text-white mb-2">{{ car.brand }} {{ car.model }}</h5>
                                    <div class="d-flex flex-wrap gap-2 mb-3">
                                        <span class="badge bg-dark border border-secondary text-light">{{ car.year }} г.</span>
                                        <span class="badge bg-dark border border-secondary text-light">{{ car.mileage }} км</span>
                                        <span class="badge bg-dark border border-secondary text-light">{{ car.fuel_type }}</span>
                                    </div>
                                    <a href="{{ url_for('main.car_detail', car_id=car.id) }}" class="btn btn-outline-success w-100 fw-bold">Преглед</a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-emoji-frown display-1 text-muted"></i>
                        <h3 class="text-muted mt-3">Не бяха открити обяви по тези критерии.</h3>
                        <a href="{{ url_for('main.search') }}" class="btn btn-link text-success">Изчисти филтрите</a>
                    </div>
                {% endif %}
            </div>

        </div>
    </div>
</div>

<style>
    body { background-color: #0f0f0f !important; color: #e0e0e0 !important; }
    
    /* Стил за картата на търсачката */
    .card { background: linear-gradient(145deg, #1a1a1a, #121212) !important; border: 1px solid #333 !important; }
    
    /* Стил за селекторите и входовете */
    .form-control, .form-select { 
        background-color: #222 !important; 
        border: 1px solid #444 !important; 
        color: #fff !important; 
        border-radius: 12px !important;
    }
    .form-control:focus, .form-select:focus { 
        border-color: #00ff85 !important; 
        box-shadow: 0 0 0 0.25rem rgba(0,255,133,0.2) !important; 
    }
    .form-label { color: #00ff85 !important; }

    /* Стил за картите с коли */
    .car-card { 
        transition: transform 0.3s ease, box-shadow 0.3s ease; 
        background: #161616 !important;
    }
    .car-card:hover { 
        transform: translateY(-10px); 
        box-shadow: 0 10px 30px rgba(0,255,133,0.2) !important;
        border: 1px solid #00ff85 !important;
    }
    .car-img { height: 200px; object-fit: cover; }

    /* Бадж за цена */
    .price-badge {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: linear-gradient(45deg, #00bf63, #00ff85);
        color: white;
        padding: 5px 15px;
        border-radius: 50px;
        font-weight: bold;
        font-size: 1.1rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }

    /* Бутони */
    .btn-success { 
        background: linear-gradient(45deg, #00bf63, #00ff85) !important; 
        border: none !important; 
        border-radius: 12px;
    }
    .btn-outline-success { 
        border: 2px solid #00ff85 !important; 
        color: #00ff85 !important; 
        border-radius: 10px;
    }
    .btn-outline-success:hover { 
        background: #00ff85 !important; 
        color: #000 !important; 
    }
</style>

<script>
    // Динамично зареждане на модели за търсачката
    document.getElementById('brand-search').addEventListener('change', function() {
        const brand = this.value;
        const modelSelect = document.getElementById('model-search');
        
        modelSelect.innerHTML = '<option value="">Зареждане...</option>';
        
        if (brand) {
            fetch(`/api/models/${encodeURIComponent(brand)}`)
                .then(response => response.json())
                .then(models => {
                    modelSelect.innerHTML = '<option value="">Всички модели</option>';
                    models.forEach(m => {
                        let opt = document.createElement('option');
                        opt.value = m;
                        opt.textContent = m;
                        modelSelect.appendChild(opt);
                    });
                })
                .catch(err => {
                    console.error("Грешка при зареждане на моделите:", err);
                    modelSelect.innerHTML = '<option value="">Всички модели</option>';
                });
        } else {
            modelSelect.innerHTML = '<option value="">Всички модели</option>';
        }
    });
</script>
{% endblock %}